<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Painel Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:Arial, sans-serif; margin:0; padding:0; background:#fafafa;}
    header{background:#111; color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:space-between;}
    main{max-width:1100px; margin:18px auto; padding:0 16px;}
    .grid{display:grid; grid-template-columns:1fr; gap:16px;}
    .card{background:#fff; border:1px solid #e6e6e6; border-radius:12px; padding:14px;}
    h2{margin:0 0 10px 0;}
    table{width:100%; border-collapse:collapse; font-size:14px;}
    th, td{border-bottom:1px solid #eee; padding:10px; text-align:left; vertical-align: middle;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{padding:4px 10px; border-radius:999px; background:#eee; font-size:12px;}
    .btn{padding:10px 12px; border-radius:10px; border:1px solid #ddd; cursor:pointer; background:#fff;}
    .btnPrimary{background:#111; color:#fff; border-color:#111;}
    input, select{padding:9px; border-radius:10px; border:1px solid #ccc;}
    label{font-weight:700; display:block; margin-top:10px; margin-bottom:6px;}
    .cols{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .full{grid-column:1/-1;}
    .muted{color:#666; font-size:12px;}
    .ok{color:#0a7a2f; font-weight:700;}
    .bad{color:#b00020; font-weight:700;}
    @media (max-width:800px){ .cols{grid-template-columns:1fr;} }

    /* ===== Tabs ===== */
    .tabs{
      max-width:1100px;
      margin:14px auto 0;
      padding:0 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tabBtn{
      border:1px solid #ddd;
      background:#fff;
      color:#111;
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:900;
    }
    .tabBtn.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .tabPanel{display:none;}
    .tabPanel.active{display:block;}

    /* ===== Confirmados (agenda) ===== */
    .agendaWrap{display:grid; grid-template-columns: 1fr; gap:12px;}
    .dayCard{border:1px solid #e6e6e6; border-radius:14px; overflow:hidden; background:#fff;}
    .dayHeader{
      padding:12px 14px;
      background:#111;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .dayHeader strong{font-size:15px;}
    .countBadge{
      background:#c9a227;
      color:#111;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      white-space:nowrap;
    }
    .slotList{padding:10px 12px 6px; display:grid; grid-template-columns: 1fr; gap:10px;}
    .slotItem{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      background:#fafafa;
    }
    .slotLeft{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .timePill{
      background:#111;
      color:#fff;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      min-width:72px;
      text-align:center;
    }
    .info{display:flex; flex-direction:column; gap:4px; font-size:13px; font-weight:700; color:#111;}
    .info small{font-weight:700; color:#666;}
    .slotRight{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
    .miniPill{
      background:#fff;
      border:1px solid #ddd;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      color:#111;
    }

    /* ===== NOVO: Grade de horários (quando filtra 1 barbeiro) ===== */
    .confViewSwitchHint{
      margin-top:8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      font-size:12px;
      color:#555;
    }
    .legend{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .legendItem{
      display:flex;
      gap:6px;
      align-items:center;
      font-weight:900;
      color:#111;
      background:#f6f6f6;
      border:1px solid #eee;
      border-radius:999px;
      padding:6px 10px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.1);
    }
    .dotBusy{background:#c9a227;}
    .dotFree{background:#eaeaea;}
    .dotLunch{background:#111;}
    .dotOff{background:#ddd;}

    .timeline{
      padding:12px;
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:8px 12px;
    }
    .tTime{
      font-weight:900;
      color:#111;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding-right:6px;
    }
    .tCard{
      border-radius:12px;
      border:1px solid #eee;
      padding:10px 12px;
      background:#fafafa;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .tCard.free{
      background:#fff;
      border-style:dashed;
      border-color:#e3e3e3;
    }
    .tCard.busy{
      background:#fff7dd;
      border-color:#f0d37a;
    }
    .tCard.lunch{
      background:#111;
      color:#fff;
      border-color:#111;
      justify-content:center;
      font-weight:900;
    }
    .tCard.off{
      background:#f3f3f3;
      color:#666;
      border-color:#e1e1e1;
      justify-content:center;
      font-weight:900;
    }
    .tMain{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:220px;
    }
    .tTitle{
      font-weight:900;
      color:#111;
      font-size:13px;
    }
    .tSub{
      color:#666;
      font-weight:800;
      font-size:12px;
    }
    .tTag{
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      color:#111;
      white-space:nowrap;
    }
    .tTagBusy{
      background:#c9a227;
      border-color:#c9a227;
      color:#111;
    }
    .tTagFree{
      background:#fff;
      border-style:dashed;
      color:#111;
    }
    .confGridView{display:none;}
    .confListView{display:block;}

    @media (max-width:560px){
      .timeline{grid-template-columns: 70px 1fr;}
      .tTime{font-size:11px;}
    }

    /* ===== Modal Calendário ===== */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 999;
    }
    .overlay.show { display: flex; }

    .cal {
      width: 360px;
      max-width: 100%;
      background: #111;
      border: 1px solid #2a2a2a;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
      color: #fff;
      font-family: Arial, sans-serif;
    }

    .cal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 12px;
      background: #0d0d0d;
      border-bottom: 1px solid #222;
    }
    .cal-title { font-weight: 900; color: #fff; font-size: 14px; }

    .cal-nav { display: flex; gap: 8px; }
    .cal-nav button {
      border: 1px solid #2a2a2a;
      background: #151515;
      color: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 900;
    }
    .cal-nav button:hover { border-color: #555; }

    .cal-body { padding: 12px; }
    .dow {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 8px;
      font-size: 11px;
      color: #bdbdbd;
      text-align: center;
      font-weight: 800;
    }
    .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }

    .day {
      border: 1px solid #2a2a2a;
      background: #141414;
      color: #fff;
      border-radius: 12px;
      padding: 10px 0;
      text-align: center;
      cursor: pointer;
      font-weight: 900;
      user-select: none;
    }
    .day:hover { border-color: #555; }
    .day.muted { opacity: .35; cursor: default; }
    .day.disabled { opacity: .25; cursor: not-allowed; }
    .day.selected {
      border-color: #c9a227;
      box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.25);
    }

    .cal-foot {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid #222;
      background: #0d0d0d;
    }
    .cal-foot button {
      flex: 1;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      font-weight: 900;
      border: 1px solid #2a2a2a;
      background: #151515;
      color: #fff;
    }
    .cal-foot button.primary {
      background: #c9a227;
      color: #111;
      border: none;
    }
  </style>
</head>
<body>
  <%
    function ymdToDmy(ymd) {
      if (!ymd || typeof ymd !== "string") return "";
      const m = ymd.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return ymd;
      return `${m[3]}-${m[2]}-${m[1]}`;
    }

    function safeJson(obj){
      // evita quebrar <script> com "<" dentro do JSON
      return JSON.stringify(obj).replace(/</g, "\\u003c");
    }

    // ===== Confirmados (status aprovado) agrupado por data =====
    const confirmados = (agendamentos || []).filter(a => a.status === "aprovado");

    const confByDate = {};
    confirmados.forEach(a => {
      const key = a.data || "";
      if (!confByDate[key]) confByDate[key] = [];
      confByDate[key].push(a);
    });

    const confDates = Object.keys(confByDate).sort((a,b) => String(a).localeCompare(String(b)));
    confDates.forEach(d => confByDate[d].sort((x,y) => String(x.horario).localeCompare(String(y.horario))));
  %>

  <header>
    <div>
      <strong>Painel Admin</strong>
      <span class="pill" style="margin-left:10px;">logado: <%= adminUser?.username %></span>
    </div>
    <form method="POST" action="/admin/logout">
      <button class="btn btnPrimary" type="submit">Sair</button>
    </form>
  </header>

  <!-- ✅ Tabs -->
  <div class="tabs">
    <button class="tabBtn active" id="tabBtnPainel" type="button">Painel</button>
    <button class="tabBtn" id="tabBtnConfirmados" type="button">Agendamentos confirmados</button>
  </div>

  <main>
    <!-- ================= TAB: PAINEL ================= -->
    <div class="tabPanel active" id="tabPainel">
      <div class="grid">

        <div class="card">
          <h2>Barbeiros</h2>
          <table>
            <thead>
              <tr>
                <th style="width:60px;">ID</th>
                <th>Nome</th>
                <th style="width:110px;">Status</th>
                <th style="width:140px;">Ação</th>
              </tr>
            </thead>
            <tbody>
              <% barbers.forEach(b => { %>
                <tr>
                  <td><%= b.id %></td>
                  <td>
                    <form method="POST" action="/admin/barbeiros/<%= b.id %>/nome" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <input name="name" value="<%= b.name %>" style="width:240px;" />
                      <button class="btn" type="submit">Salvar</button>
                    </form>
                  </td>
                  <td><%= b.is_active ? "Ativo" : "Inativo" %></td>
                  <td>
                    <form method="POST" action="/admin/barbeiros/<%= b.id %>/toggle" style="display:inline;">
                      <button class="btn" type="submit"><%= b.is_active ? "Desativar" : "Ativar" %></button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h2>Agendar manualmente</h2>
          <div class="muted">Clique no campo de data para abrir o calendário e escolher o dia.</div>

          <form method="POST" action="/admin/agendar" id="adminAgendarForm">
            <div class="cols">
              <div>
                <label>Barbeiro</label>
                <select name="barberId" id="admBarberId" required>
                  <option value="">Selecione</option>
                  <% barbers.forEach(b => { %>
                    <option value="<%= b.id %>"><%= b.name %></option>
                  <% }) %>
                </select>
              </div>

              <div>
                <label>Data (dd-mm-yyyy)</label>
                <input name="data" id="admData" placeholder="Clique para escolher" required readonly style="cursor:pointer; background:#f9f9f9;" />
                <div class="muted">Abrirá o calendário ao clicar.</div>
              </div>

              <div>
                <label>Horário</label>
                <select name="horario" id="admHorario" required disabled>
                  <option value="">Selecione barbeiro e data</option>
                </select>
                <div id="admHorarioMsg" class="muted"></div>
              </div>

              <div>
                <label>Status</label>
                <select name="status">
                  <option value="agendado" selected>agendado</option>
                  <option value="aprovado">aprovado</option>
                  <option value="cancelado">cancelado</option>
                </select>
              </div>

              <div>
                <label>Nome do cliente</label>
                <input name="nome" placeholder="Nome do cliente" required />
              </div>

              <div>
                <label>Telefone</label>
                <input name="telefone" placeholder="Ex: 5599999999999" />
              </div>

              <div class="full">
                <button class="btn btnPrimary" type="submit">Salvar agendamento</button>
              </div>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <h2 style="margin:0;">Agendamentos</h2>

            <div class="row">
              <span class="muted" style="font-weight:700;">Filtrar:</span>

              <select id="barberFilter">
                <option value="all">Todos os barbeiros</option>
                <% barbers.forEach(b => { %>
                  <option value="<%= b.id %>"><%= b.name %></option>
                <% }) %>
              </select>

              <label style="margin:0; font-weight:900; display:flex; align-items:center; gap:8px;">
                Data:
                <input type="date" id="dateFilter" />
              </label>

              <label style="margin:0; font-weight:900; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="showCancelados" />
                Cancelados
              </label>

              <label style="margin:0; font-weight:900; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="showAprovados" />
                Aprovados
              </label>

              <button class="btn" type="button" id="btnHoje">Hoje</button>
              <button class="btn" type="button" id="btnTodosDias">Todos os dias</button>
            </div>
          </div>

          <div class="muted" id="countInfo" style="margin:8px 0 12px;">—</div>

          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Hora</th>
                <th>Cliente</th>
                <th>Telefone</th>
                <th>Barbeiro</th>
                <th>Status</th>
                <th>Mudar</th>
              </tr>
            </thead>
            <tbody id="agendBody">
              <% agendamentos.forEach(a => { %>
                <tr
                  class="agRow"
                  data-id="<%= a.id %>"
                  data-barber-id="<%= a.barber_id %>"
                  data-status="<%= a.status %>"
                  data-date="<%= a.data %>"
                >
                  <td><%= ymdToDmy(a.data) %></td>
                  <td><%= a.horario %></td>
                  <td><%= a.nome %></td>
                  <td><%= a.telefone || "" %></td>
                  <td><%= a.barber_name || "" %></td>
                  <td><span class="pill jsStatusPill"><%= a.status %></span></td>
                  <td>
                    <select onchange="updateStatus(<%= a.id %>, this.value)">
                      <option value="agendado" <%= a.status==="agendado" ? "selected" : "" %>>agendado</option>
                      <option value="aprovado" <%= a.status==="aprovado" ? "selected" : "" %>>aprovado</option>
                      <option value="cancelado" <%= a.status==="cancelado" ? "selected" : "" %>>cancelado</option>
                    </select>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h2>Configuração por barbeiro</h2>

          <% barbers.forEach(b => {
              const cfg = barberConfigs[b.id];
              const dmyList = (cfg.daysOffDates || []).map(ymdToDmy).join(", ");
          %>
            <hr style="border:0; border-top:1px solid #eee; margin:18px 0;">
            <h3 style="margin:0 0 10px 0;"><%= b.name %> (ID <%= b.id %>)</h3>

            <form method="POST" action="/admin/barbeiro/<%= b.id %>/config">
              <div class="cols">
                <div>
                  <label>Início</label>
                  <input name="start" value="<%= cfg.start %>" placeholder="09:00" required />
                </div>
                <div>
                  <label>Fim</label>
                  <input name="end" value="<%= cfg.end %>" placeholder="18:00" required />
                </div>

                <div>
                  <label>Almoço (início)</label>
                  <input name="lunchStart" value="<%= cfg.lunchStart %>" placeholder="12:00" required />
                </div>
                <div>
                  <label>Almoço (fim)</label>
                  <input name="lunchEnd" value="<%= cfg.lunchEnd %>" placeholder="13:00" required />
                </div>

                <div class="full">
                  <label>Duração do slot (minutos)</label>
                  <input name="slotMinutes" type="number" value="<%= cfg.slotMinutes %>" min="10" max="240" required />
                </div>

                <div class="full">
                  <label>Dias de trabalho</label>
                  <div class="row">
                    <label><input type="checkbox" name="wd0" <%= cfg.workDays[0] ? "checked" : "" %> /> Dom</label>
                    <label><input type="checkbox" name="wd1" <%= cfg.workDays[1] ? "checked" : "" %> /> Seg</label>
                    <label><input type="checkbox" name="wd2" <%= cfg.workDays[2] ? "checked" : "" %> /> Ter</label>
                    <label><input type="checkbox" name="wd3" <%= cfg.workDays[3] ? "checked" : "" %> /> Qua</label>
                    <label><input type="checkbox" name="wd4" <%= cfg.workDays[4] ? "checked" : "" %> /> Qui</label>
                    <label><input type="checkbox" name="wd5" <%= cfg.workDays[5] ? "checked" : "" %> /> Sex</label>
                    <label><input type="checkbox" name="wd6" <%= cfg.workDays[6] ? "checked" : "" %> /> Sáb</label>
                  </div>
                </div>

                <div class="full">
                  <label>Folgas (dd-mm-yyyy, separadas por vírgula/espaco)</label>
                  <input name="daysOffDates" value="<%= dmyList %>" placeholder="10-02-2026, 11-02-2026" />
                  <div class="muted">Você pode colar também no formato yyyy-mm-dd que o sistema aceita e converte.</div>
                </div>

                <div class="full">
                  <button class="btn btnPrimary" type="submit">Salvar config do <%= b.name %></button>
                </div>
              </div>
            </form>
          <% }) %>
        </div>
      </div>
    </div>

    <!-- ================= TAB: CONFIRMADOS ================= -->
    <div class="tabPanel" id="tabConfirmados">
      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div>
              <h2 style="margin:0;">Agendamentos confirmados</h2>
              <div class="muted">Apenas status <strong>aprovado</strong>, agrupado por dia.</div>

              <div class="confViewSwitchHint">
                <span class="pill" style="background:#f6f6f6; border:1px solid #eee; font-weight:900;">
                  Dica: selecione <strong>1 barbeiro</strong> pra ver a <strong>grade de horários</strong> (Livre/Ocupado).
                </span>

                <div class="legend">
                  <span class="legendItem"><span class="dot dotBusy"></span> Ocupado</span>
                  <span class="legendItem"><span class="dot dotFree"></span> Livre</span>
                  <span class="legendItem"><span class="dot dotLunch"></span> Almoço</span>
                  <span class="legendItem"><span class="dot dotOff"></span> Fora do expediente</span>
                </div>
              </div>
            </div>

            <div class="row">
              <span class="muted" style="font-weight:700;">Barbeiro:</span>
              <select id="confBarberFilter">
                <option value="all">Todos</option>
                <% barbers.forEach(b => { %>
                  <option value="<%= b.id %>"><%= b.name %></option>
                <% }) %>
              </select>

              <span class="pill" style="background:#f1f1f1;">Total: <span id="confTotal"><%= confirmados.length %></span></span>
            </div>
          </div>

          <!-- dados p/ montar a grade via JS -->
          <script id="barberConfigsJson" type="application/json"><%- safeJson(barberConfigs) %></script>
          <script id="barbersJson" type="application/json"><%- safeJson(barbers) %></script>
        </div>

        <div class="card">
          <% if (!confirmados.length) { %>
            <div class="muted">Nenhum agendamento confirmado (aprovado) até o momento.</div>
          <% } else { %>
            <div class="agendaWrap" id="confAgenda">
              <% confDates.forEach(dateKey => {
                   const items = confByDate[dateKey] || [];
              %>
                <div class="dayCard confDayCard" data-date="<%= dateKey %>">
                  <div class="dayHeader">
                    <strong><%= ymdToDmy(dateKey) %></strong>
                    <span class="countBadge">
                      <span class="confDayCount"><%= items.length %></span>
                      <span class="confDaySuffix"> horário(s)</span>
                    </span>
                  </div>

                  <!-- JSON dos confirmados do dia (pra montar a grade) -->
                  <script class="confItemsJson" type="application/json"><%- safeJson(items) %></script>

                  <!-- LISTA (modo "Todos") -->
                  <div class="confListView">
                    <div class="slotList">
                      <% items.forEach(a => { %>
                        <div class="slotItem confSlot" data-barber-id="<%= a.barber_id %>">
                          <div class="slotLeft">
                            <span class="timePill"><%= a.horario %></span>
                            <div class="info">
                              <div><%= a.nome %></div>
                              <small>Barbeiro: <%= a.barber_name || "" %> • Tel: <%= a.telefone || "-" %></small>
                            </div>
                          </div>
                          <div class="slotRight">
                            <span class="miniPill">confirmado</span>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  </div>

                  <!-- GRADE (modo 1 barbeiro) -->
                  <div class="confGridView">
                    <div class="timeline" data-role="timeline"></div>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <div id="admOverlay" class="overlay" aria-hidden="true">
    <div class="cal" role="dialog" aria-modal="true" aria-label="Selecionar data">
      <div class="cal-head">
        <div class="cal-title" id="admCalTitle">Mês</div>
        <div class="cal-nav">
          <button type="button" id="admPrevMonth">◀</button>
          <button type="button" id="admNextMonth">▶</button>
        </div>
      </div>

      <div class="cal-body">
        <div class="dow">
          <div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>SÁB</div>
        </div>
        <div id="admDays" class="days"></div>
      </div>

      <div class="cal-foot">
        <button type="button" id="admCancelCal">Cancelar</button>
        <button type="button" class="primary" id="admOkCal">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== updateStatus (corrigido: recarrega se entrou/saiu de aprovado) =====
    async function updateStatus(id, status) {
      const row = document.querySelector(`.agRow[data-id="${id}"]`);
      const prevStatus = row ? row.getAttribute("data-status") : null;

      await fetch("/admin/status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, status })
      });

      // atualiza visualmente a linha (para filtros funcionarem sem recarregar)
      if (row) {
        row.setAttribute("data-status", status);
        const pill = row.querySelector(".jsStatusPill");
        if (pill) pill.textContent = status;
      }

      // entrou OU saiu de "aprovado" => recarrega para sincronizar a aba "confirmados"
      const touchedApproved = (prevStatus === "aprovado") || (status === "aprovado");
      if (touchedApproved) {
        try {
          localStorage.setItem("admin_tab", status === "aprovado" ? "confirmados" : "painel");
        } catch (e) {}
        window.location.reload();
        return;
      }

      applyFilters();
    }

    // ===== Tabs =====
    const tabBtnPainel = document.getElementById("tabBtnPainel");
    const tabBtnConfirmados = document.getElementById("tabBtnConfirmados");
    const tabPainel = document.getElementById("tabPainel");
    const tabConfirmados = document.getElementById("tabConfirmados");

    function setTab(name){
      const isPainel = name === "painel";
      tabBtnPainel.classList.toggle("active", isPainel);
      tabBtnConfirmados.classList.toggle("active", !isPainel);
      tabPainel.classList.toggle("active", isPainel);
      tabConfirmados.classList.toggle("active", !isPainel);
      try { localStorage.setItem("admin_tab", name); } catch(e){}
    }

    tabBtnPainel.addEventListener("click", () => setTab("painel"));
    tabBtnConfirmados.addEventListener("click", () => setTab("confirmados"));

    try {
      const saved = localStorage.getItem("admin_tab");
      if(saved === "confirmados") setTab("confirmados");
    } catch(e){}

    // ===== filtros (barbeiro + data + checkboxes) =====
    const barberFilter = document.getElementById("barberFilter");
    const dateFilter = document.getElementById("dateFilter");
    const showCancelados = document.getElementById("showCancelados");
    const showAprovados = document.getElementById("showAprovados");
    const btnHoje = document.getElementById("btnHoje");
    const btnTodosDias = document.getElementById("btnTodosDias");

    const rows = Array.from(document.querySelectorAll(".agRow"));
    const countInfo = document.getElementById("countInfo");

    function todayYMD(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    if (dateFilter) dateFilter.value = todayYMD();

    function applyFilters() {
      const barberVal = barberFilter.value;
      const selectedDate = (dateFilter && dateFilter.value) ? dateFilter.value : "";
      const canShowCancelados = !!(showCancelados && showCancelados.checked);
      const canShowAprovados = !!(showAprovados && showAprovados.checked);

      let visible = 0;

      rows.forEach(r => {
        const bid = r.getAttribute("data-barber-id");
        const st = r.getAttribute("data-status");
        const dt = r.getAttribute("data-date");

        const barberOk = (barberVal === "all") || (bid === barberVal);
        const dateOk = (!selectedDate) || (dt === selectedDate);

        // padrão: só agendado; checkboxes adicionam cancelado/aprovado
        const statusOk =
          (st === "agendado") ||
          (canShowCancelados && st === "cancelado") ||
          (canShowAprovados && st === "aprovado");

        const show = barberOk && dateOk && statusOk;

        r.style.display = show ? "" : "none";
        if (show) visible++;
      });

      let extra = ["agendado"];
      if (canShowCancelados) extra.push("cancelado");
      if (canShowAprovados) extra.push("aprovado");

      const dateText = selectedDate ? ` • Data: ${selectedDate}` : " • Data: todas";
      countInfo.textContent = `Mostrando ${visible} de ${rows.length} (${extra.join(" + ")})${dateText}`;
    }

    barberFilter.addEventListener("change", applyFilters);
    if (dateFilter) dateFilter.addEventListener("change", applyFilters);
    if (showCancelados) showCancelados.addEventListener("change", applyFilters);
    if (showAprovados) showAprovados.addEventListener("change", applyFilters);

    if (btnHoje) btnHoje.addEventListener("click", () => {
      if (dateFilter) dateFilter.value = todayYMD();
      applyFilters();
    });

    if (btnTodosDias) btnTodosDias.addEventListener("click", () => {
      if (dateFilter) dateFilter.value = "";
      applyFilters();
    });

    applyFilters();

    // ===== Confirmados: LISTA (modo "Todos") + GRADE (modo 1 barbeiro) =====
    const confBarberFilter = document.getElementById("confBarberFilter");
    const confTotalEl = document.getElementById("confTotal");
    const confDayCards = Array.from(document.querySelectorAll(".confDayCard"));

    function safeParseJsonScript(selectorOrEl){
      try{
        const el = (typeof selectorOrEl === "string") ? document.querySelector(selectorOrEl) : selectorOrEl;
        if(!el) return null;
        return JSON.parse(el.textContent || "null");
      }catch(e){
        return null;
      }
    }

    function toMinutes(hhmm){
      const m = String(hhmm || "").match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return null;
      return (parseInt(m[1],10)*60) + parseInt(m[2],10);
    }
    function toHHMM(min){
      const h = Math.floor(min/60);
      const m = min%60;
      return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
    }

    const barberConfigs = safeParseJsonScript("#barberConfigsJson") || {};
    const barbersList = safeParseJsonScript("#barbersJson") || [];

    function barberNameById(id){
      const f = barbersList.find(b => String(b.id) === String(id));
      return f ? f.name : "";
    }

    function buildTimelineHTML({ dateYMD, cfg, items, barberId }){
      // items já filtrados pro barbeiro
      const start = toMinutes(cfg.start);
      const end = toMinutes(cfg.end);
      const lunchStart = toMinutes(cfg.lunchStart);
      const lunchEnd = toMinutes(cfg.lunchEnd);
      const step = Math.max(10, parseInt(cfg.slotMinutes || 30, 10));

      if(start == null || end == null || step == null) return `<div class="muted">Configuração inválida de horários.</div>`;

      const byTime = {};
      (items || []).forEach(a => {
        const key = String(a.horario || "");
        if(key) byTime[key] = a;
      });

      const lines = [];
      // antes do expediente (opcional: mostrar só um bloco)
      // aqui preferi não poluir com muitos "off", só montar do start até end.

      for(let t = start; t < end; t += step){
        const hhmm = toHHMM(t);

        // almoço: coloca 1 bloco centralizado no início do almoço e pula até lunchEnd
        if(lunchStart != null && lunchEnd != null && t === lunchStart){
          lines.push(`
            <div class="tTime">${hhmm}</div>
            <div class="tCard lunch">ALMOÇO • ${toHHMM(lunchStart)} - ${toHHMM(lunchEnd)}</div>
          `);
          // pula para o fim do almoço
          t = lunchEnd - step;
          continue;
        }

        const ap = byTime[hhmm];

        if(ap){
          const nome = ap.nome || "Cliente";
          const tel = ap.telefone || "-";
          const bname = ap.barber_name || barberNameById(barberId) || "";
          lines.push(`
            <div class="tTime">${hhmm}</div>
            <div class="tCard busy">
              <div class="tMain">
                <div class="tTitle">${escapeHtml(nome)}</div>
                <div class="tSub">Barbeiro: ${escapeHtml(bname)} • Tel: ${escapeHtml(tel)}</div>
              </div>
              <span class="tTag tTagBusy">OCUPADO</span>
            </div>
          `);
        } else {
          lines.push(`
            <div class="tTime">${hhmm}</div>
            <div class="tCard free">
              <div class="tMain">
                <div class="tTitle">Livre</div>
                <div class="tSub">Nenhum agendamento confirmado nesse horário</div>
              </div>
              <span class="tTag tTagFree">LIVRE</span>
            </div>
          `);
        }
      }

      return lines.join("");
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function applyConfirmedUI(){
      if(!confBarberFilter) return;

      const barberVal = confBarberFilter.value; // "all" ou id
      const isAll = (barberVal === "all");

      let totalVisible = 0;

      confDayCards.forEach(dayCard => {
        const listView = dayCard.querySelector(".confListView");
        const gridView = dayCard.querySelector(".confGridView");
        const timelineEl = dayCard.querySelector('[data-role="timeline"]');
        const dayCountEl = dayCard.querySelector(".confDayCount");
        const suffixEl = dayCard.querySelector(".confDaySuffix");
        const dateYMD = dayCard.getAttribute("data-date");

        // itens do dia (todos barbeiros)
        const itemsJsonEl = dayCard.querySelector(".confItemsJson");
        const itemsAll = safeParseJsonScript(itemsJsonEl) || [];

        if(isAll){
          // modo LISTA (igual era antes)
          if(listView) listView.style.display = "block";
          if(gridView) gridView.style.display = "none";

          // filtra a lista (antigo comportamento: mostra tudo, porque "todos")
          const slots = Array.from(dayCard.querySelectorAll(".confSlot"));
          let dayVisible = 0;
          slots.forEach(slot => {
            slot.style.display = "";
            dayVisible++;
          });

          if(dayCountEl) dayCountEl.textContent = String(dayVisible);
          if(suffixEl) suffixEl.textContent = " horário(s)";
          dayCard.style.display = dayVisible > 0 ? "" : "none";
          totalVisible += dayVisible;
          return;
        }

        // modo GRADE (1 barbeiro)
        const cfg = barberConfigs[barberVal];
        if(!cfg){
          // sem config => cai pra lista filtrada só desse barbeiro
          if(listView) listView.style.display = "block";
          if(gridView) gridView.style.display = "none";

          const slots = Array.from(dayCard.querySelectorAll(".confSlot"));
          let dayVisible = 0;
          slots.forEach(slot => {
            const bid = slot.getAttribute("data-barber-id");
            const show = (bid === barberVal);
            slot.style.display = show ? "" : "none";
            if(show) dayVisible++;
          });

          if(dayCountEl) dayCountEl.textContent = String(dayVisible);
          if(suffixEl) suffixEl.textContent = " horário(s)";
          dayCard.style.display = dayVisible > 0 ? "" : "none";
          totalVisible += dayVisible;
          return;
        }

        // filtra itens do dia pro barbeiro selecionado
        const items = (itemsAll || []).filter(a => String(a.barber_id) === String(barberVal));
        const dayBusy = items.length;

        // monta grade
        if(listView) listView.style.display = "none";
        if(gridView) gridView.style.display = "block";
        if(timelineEl){
          timelineEl.innerHTML = buildTimelineHTML({
            dateYMD,
            cfg,
            items,
            barberId: barberVal
          });
        }

        // badge do dia: "ocupados / totalSlots"
        const start = toMinutes(cfg.start);
        const end = toMinutes(cfg.end);
        const lunchStart = toMinutes(cfg.lunchStart);
        const lunchEnd = toMinutes(cfg.lunchEnd);
        const step = Math.max(10, parseInt(cfg.slotMinutes || 30, 10));
        let totalSlots = 0;

        if(start != null && end != null){
          for(let t = start; t < end; t += step){
            if(lunchStart != null && lunchEnd != null && t >= lunchStart && t < lunchEnd) continue;
            totalSlots++;
          }
        }

        if(dayCountEl) dayCountEl.textContent = `${dayBusy}/${totalSlots}`;
        if(suffixEl) suffixEl.textContent = " ocupados";

        // mostra o dia mesmo se tiver 0 confirmado (pra ver LIVRE)
        dayCard.style.display = "";
        totalVisible += dayBusy;
      });

      if (confTotalEl) confTotalEl.textContent = String(totalVisible);
    }

    if (confBarberFilter) {
      confBarberFilter.addEventListener("change", applyConfirmedUI);
      applyConfirmedUI();
    }

    // ===== horários no admin =====
    const admBarberId = document.getElementById("admBarberId");
    const admData = document.getElementById("admData");
    const admHorario = document.getElementById("admHorario");
    const admHorarioMsg = document.getElementById("admHorarioMsg");

    function toYMD(input) {
      const s = String(input || "").trim();
      if (!s) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;
      return null;
    }

    async function refreshAdminHorarios(){
      const bId = admBarberId.value;
      const dataYMD = toYMD(admData.value);

      admHorario.innerHTML = `<option value="">Selecione barbeiro e data</option>`;
      admHorario.disabled = true;
      admHorarioMsg.textContent = "";

      if (!bId) return;
      if (!dataYMD) {
        admHorarioMsg.innerHTML = `<span class="bad">Escolha a data no calendário.</span>`;
        return;
      }

      admHorarioMsg.textContent = "Carregando horários...";
      try{
        const res = await fetch(`/horarios?data=${encodeURIComponent(dataYMD)}&barberId=${encodeURIComponent(bId)}`);
        if(!res.ok) throw new Error("Falha ao buscar horários.");
        const horarios = await res.json();

        if(!Array.isArray(horarios) || horarios.length === 0){
          admHorarioMsg.innerHTML = `<span class="bad">Nenhum horário disponível nessa data.</span>`;
          return;
        }

        admHorario.innerHTML = `<option value="">Selecione um horário</option>`;
        horarios.forEach(h => {
          const opt = document.createElement("option");
          opt.value = h;
          opt.textContent = h;
          admHorario.appendChild(opt);
        });

        admHorario.disabled = false;
        admHorarioMsg.innerHTML = `<span class="ok">Horários carregados ✅</span>`;
      }catch(e){
        admHorarioMsg.innerHTML = `<span class="bad">Erro ao buscar horários.</span>`;
      }
    }

    admBarberId.addEventListener("change", () => refreshAdminHorarios());

    // ===== calendário modal =====
    const overlay = document.getElementById("admOverlay");
    const daysEl = document.getElementById("admDays");
    const titleEl = document.getElementById("admCalTitle");
    const prevBtn = document.getElementById("admPrevMonth");
    const nextBtn = document.getElementById("admNextMonth");
    const cancelBtn = document.getElementById("admCancelCal");
    const okBtn = document.getElementById("admOkCal");

    const today = new Date();
    const minDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    let viewYear = minDate.getFullYear();
    let viewMonth = minDate.getMonth();
    let tempSelected = null;

    function pad2(n){ return String(n).padStart(2, "0"); }
    function toDMY(d){ return `${pad2(d.getDate())}-${pad2(d.getMonth()+1)}-${d.getFullYear()}`; }

    function openCal(){
      tempSelected = null;
      renderCalendar();
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");
    }
    function closeCal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden", "true");
    }

    function renderCalendar(){
      const monthNames = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      titleEl.textContent = `${monthNames[viewMonth]} ${viewYear}`;

      daysEl.innerHTML = "";
      const first = new Date(viewYear, viewMonth, 1);
      const firstDow = first.getDay();
      const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();

      for(let i=0;i<firstDow;i++){
        const div = document.createElement("div");
        div.className = "day muted";
        div.textContent = "";
        daysEl.appendChild(div);
      }

      for(let d=1; d<=daysInMonth; d++){
        const dt = new Date(viewYear, viewMonth, d);
        const div = document.createElement("div");
        div.className = "day";
        div.textContent = String(d);

        if (dt < minDate) div.classList.add("disabled");

        if (tempSelected &&
            dt.getFullYear()===tempSelected.getFullYear() &&
            dt.getMonth()===tempSelected.getMonth() &&
            dt.getDate()===tempSelected.getDate()) {
          div.classList.add("selected");
        }

        div.addEventListener("click", () => {
          if (div.classList.contains("disabled") || div.classList.contains("muted")) return;
          tempSelected = dt;
          renderCalendar();
        });

        daysEl.appendChild(div);
      }
    }

    prevBtn.addEventListener("click", () => {
      viewMonth--;
      if(viewMonth < 0){ viewMonth = 11; viewYear--; }
      renderCalendar();
    });
    nextBtn.addEventListener("click", () => {
      viewMonth++;
      if(viewMonth > 11){ viewMonth = 0; viewYear++; }
      renderCalendar();
    });

    cancelBtn.addEventListener("click", closeCal);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeCal(); });

    okBtn.addEventListener("click", async () => {
      if (!tempSelected) return;
      admData.value = toDMY(tempSelected);
      closeCal();
      await refreshAdminHorarios();
    });

    admData.addEventListener("click", openCal);
  </script>
</body>
</html>
