<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agendar Hor√°rio | Gold Barber</title>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b0b0b;
      color: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 760px;
      margin: 0 auto;
      background: #121212;
      border: 1px solid #222;
      border-radius: 16px;
      padding: 18px;
    }
    h1 { margin: 0 0 8px; font-size: 22px; }
    p { margin: 0 0 14px; color: #bdbdbd; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .full { grid-column: 1 / -1; }

    label {
      font-size: 14px;
      color: #fff;
      font-weight: 800;
      margin-bottom: 6px;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: 2px solid #3a3a3a;
      background: #0f0f0f;
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      outline: none;
    }

    input:focus, select:focus {
      border-color: #c9a227;
      box-shadow: 0 0 0 3px rgba(201,162,39,.25);
    }

    select:disabled, input:disabled { opacity: .55; cursor: not-allowed; }

    .hint { font-size: 13px; color: #d7d7d7; margin-top: 8px; font-weight: 700; }

    .card {
      margin-top: 16px;
      background: #0f0f0f;
      border: 1px solid #222;
      border-radius: 16px;
      padding: 14px;
    }
    .subinfo { font-size: 12px; color: #bdbdbd; margin-top: 6px; }

    .horarios { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }

    .hora {
      border: 2px solid #2a2a2a;
      background: #121212;
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 800;
    }
    .hora:hover { border-color: #555; }
    .hora.selected {
      border-color: #c9a227;
      box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.25);
    }

    button.confirmar {
      margin-top: 14px;
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: #c9a227;
      color: #111;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
    }
    button.confirmar:disabled { opacity: 0.5; cursor: not-allowed; }

    .msg {
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      background: #0c0c0c;
      border: 1px solid #333;
      display: none;
      font-size: 13px;
      color: #ddd;
      white-space: pre-line;
    }
    .msg.show { display: block; }
    .msg.error { border-color: #7a2b2b; color: #ffbaba; }

    /* Modal calend√°rio */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 999;
    }
    .overlay.show { display: flex; }

    .cal {
      width: 360px;
      max-width: 100%;
      background: #111;
      border: 1px solid #2a2a2a;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
    }
    .cal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 12px;
      background: #0d0d0d;
      border-bottom: 1px solid #222;
    }
    .cal-title { font-weight: 900; color: #fff; font-size: 14px; }
    .cal-nav { display: flex; gap: 8px; }
    .cal-nav button {
      border: 1px solid #2a2a2a;
      background: #151515;
      color: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 900;
    }

    .cal-body { padding: 12px; }
    .dow {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 8px;
      font-size: 11px;
      color: #bdbdbd;
      text-align: center;
      font-weight: 800;
    }
    .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .day {
      border: 1px solid #2a2a2a;
      background: #141414;
      color: #fff;
      border-radius: 12px;
      padding: 10px 0;
      text-align: center;
      cursor: pointer;
      font-weight: 900;
      user-select: none;
    }
    .day:hover { border-color: #555; }
    .day.disabled { opacity: .25; cursor: not-allowed; }
    .day.muted { opacity: .35; cursor: default; }
    .day.selected {
      border-color: #c9a227;
      box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.25);
    }

    .cal-foot {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid #222;
      background: #0d0d0d;
    }
    .cal-foot button {
      flex: 1;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      font-weight: 900;
      border: 1px solid #2a2a2a;
      background: #151515;
      color: #fff;
    }
    .cal-foot button.primary { background: #c9a227; color: #111; border: none; }

    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="container">
    <h1>üíà Agendar Hor√°rio</h1>
    <p>NOME ‚Üí BARBEIRO ‚Üí DATA ‚Üí hor√°rios do barbeiro escolhido.</p>

    <form id="formAgendar" method="POST" action="/agendar">
      <div class="grid">
        <div class="full">
          <label>Nome</label>
          <input id="nome" name="nome" required minlength="2" placeholder="Seu nome" />
        </div>

        <div class="full">
          <label>üíá‚Äç‚ôÇÔ∏è Barbeiro</label>
          <select id="barberSelect" required>
            <option value="">Carregando barbeiros...</option>
          </select>
          <div class="hint">Escolha o barbeiro para liberar a sele√ß√£o de data.</div>
        </div>

        <input id="barberId" type="hidden" name="barberId" />
        <input id="token" type="hidden" name="token" />

        <div class="full">
          <label>üìÖ Data do agendamento</label>
          <input id="dataVisual" type="text" placeholder="Escolha o barbeiro primeiro" readonly disabled />
          <div id="dataHuman" class="hint"></div>
        </div>

        <input id="dataReal" type="hidden" name="data" />
        <input id="horarioReal" type="hidden" name="horario" />
      </div>

      <div class="card">
        <strong>Hor√°rios dispon√≠veis</strong>
        <div id="subinfo" class="subinfo">Escolha um barbeiro para liberar a data.</div>
        <div id="horarios" class="horarios"></div>

        <button id="btnConfirmar" class="confirmar" type="submit" disabled>
          Confirmar Agendamento
        </button>

        <div id="msg" class="msg"></div>
      </div>
    </form>
  </div>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="cal" role="dialog" aria-modal="true" aria-label="Selecionar data">
      <div class="cal-head">
        <div class="cal-title" id="calTitle">M√™s</div>
        <div class="cal-nav">
          <button type="button" id="prevMonth">‚óÄ</button>
          <button type="button" id="nextMonth">‚ñ∂</button>
        </div>
      </div>

      <div class="cal-body">
        <div class="dow">
          <div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>S√ÅB</div>
        </div>
        <div id="days" class="days"></div>
      </div>

      <div class="cal-foot">
        <button type="button" id="cancelCal">Cancelar</button>
        <button type="button" class="primary" id="okCal">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    const elBarberSelect = document.getElementById("barberSelect");
    const elBarberId = document.getElementById("barberId");
    const elDataVisual = document.getElementById("dataVisual");
    const elDataReal = document.getElementById("dataReal");
    const elHorarios = document.getElementById("horarios");
    const elSubinfo = document.getElementById("subinfo");
    const elHorarioReal = document.getElementById("horarioReal");
    const elBtnConfirmar = document.getElementById("btnConfirmar");
    const elMsg = document.getElementById("msg");
    const elToken = document.getElementById("token");

    const elOverlay = document.getElementById("overlay");
    const elDays = document.getElementById("days");
    const elTitle = document.getElementById("calTitle");
    const btnPrev = document.getElementById("prevMonth");
    const btnNext = document.getElementById("nextMonth");
    const btnCancel = document.getElementById("cancelCal");
    const btnOk = document.getElementById("okCal");

    // token whatsapp ?t=...
    const params = new URLSearchParams(window.location.search);
    const t = params.get("t");
    if (t) elToken.value = t;

    const today = new Date();
    const minDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    let viewYear = minDate.getFullYear();
    let viewMonth = minDate.getMonth();
    let tempSelected = null;

    function pad2(n){ return String(n).padStart(2, "0"); }
    function toYMD(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function ymdToHuman(ymd){
      const [y,m,d] = ymd.split("-").map(Number);
      const dt = new Date(y, m-1, d);
      const dias = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
      return `${dias[dt.getDay()]} - ${pad2(d)}/${pad2(m)}/${y}`;
    }
    function showMsg(text, isError=false){
      elMsg.textContent = text;
      elMsg.className = "msg show" + (isError ? " error" : "");
    }
    function clearMsg(){
      elMsg.textContent = "";
      elMsg.className = "msg";
    }
    function resetDataEHorarios(msg){
      elDataReal.value = "";
      elDataVisual.value = "";
      elHorarios.innerHTML = "";
      elHorarioReal.value = "";
      elBtnConfirmar.disabled = true;
      elSubinfo.textContent = msg || "Escolha uma data para carregar os hor√°rios.";
    }

    async function carregarBarbeiros(){
      try{
        const res = await fetch("/barbeiros");
        if(!res.ok) throw new Error("Falha ao buscar barbeiros.");
        const barbers = await res.json();

        elBarberSelect.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "Selecione um barbeiro";
        elBarberSelect.appendChild(opt0);

        (barbers || []).forEach(b => {
          const opt = document.createElement("option");
          opt.value = String(b.id);
          opt.textContent = b.name;
          elBarberSelect.appendChild(opt);
        });

        if(!barbers || barbers.length === 0){
          elBarberSelect.innerHTML = `<option value="">Nenhum barbeiro dispon√≠vel</option>`;
          elBarberSelect.disabled = true;
          resetDataEHorarios("Nenhum barbeiro ativo no momento.");
          return;
        }

        elBarberSelect.disabled = false;
        resetDataEHorarios("Escolha um barbeiro para liberar a data.");
      }catch(e){
        elBarberSelect.innerHTML = `<option value="">Erro ao carregar barbeiros</option>`;
        showMsg("Erro: " + (e?.message || "Erro desconhecido"), true);
      }
    }

    elBarberSelect.addEventListener("change", () => {
      clearMsg();

      const bId = elBarberSelect.value;
      elBarberId.value = bId || "";

      if (!bId) {
        elDataVisual.disabled = true;
        elDataVisual.value = "";
        elDataVisual.placeholder = "Escolha o barbeiro primeiro";
        resetDataEHorarios("Escolha um barbeiro para liberar a data.");
        return;
      }

      elDataVisual.disabled = false;
      elDataVisual.placeholder = "Clique para escolher a data";
      resetDataEHorarios("Agora escolha uma data para carregar os hor√°rios.");
    });

    function openCal(){
      clearMsg();
      if (!elBarberId.value) return showMsg("Selecione um barbeiro primeiro.", true);
      tempSelected = null;
      renderCalendar();
      elOverlay.classList.add("show");
      elOverlay.setAttribute("aria-hidden", "false");
    }
    function closeCal(){
      elOverlay.classList.remove("show");
      elOverlay.setAttribute("aria-hidden", "true");
    }

    function renderCalendar(){
      const monthNames = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      elTitle.textContent = `${monthNames[viewMonth]} ${viewYear}`;
      elDays.innerHTML = "";

      const first = new Date(viewYear, viewMonth, 1);
      const firstDow = first.getDay();
      const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();

      for(let i=0;i<firstDow;i++){
        const div = document.createElement("div");
        div.className = "day muted";
        div.textContent = "";
        elDays.appendChild(div);
      }

      for(let d=1; d<=daysInMonth; d++){
        const dt = new Date(viewYear, viewMonth, d);
        const div = document.createElement("div");
        div.className = "day";
        div.textContent = String(d);

        const beforeMin = dt < minDate;
        if (beforeMin) div.classList.add("disabled");

        if (tempSelected && dt.getFullYear()===tempSelected.getFullYear() && dt.getMonth()===tempSelected.getMonth() && dt.getDate()===tempSelected.getDate()){
          div.classList.add("selected");
        }

        div.addEventListener("click", () => {
          if (div.classList.contains("disabled") || div.classList.contains("muted")) return;
          tempSelected = dt;
          renderCalendar();
        });

        elDays.appendChild(div);
      }
    }

    btnPrev.addEventListener("click", () => {
      viewMonth--;
      if(viewMonth < 0){ viewMonth = 11; viewYear--; }
      renderCalendar();
    });
    btnNext.addEventListener("click", () => {
      viewMonth++;
      if(viewMonth > 11){ viewMonth = 0; viewYear++; }
      renderCalendar();
    });

    btnCancel.addEventListener("click", closeCal);
    elOverlay.addEventListener("click", (e) => { if (e.target === elOverlay) closeCal(); });

    btnOk.addEventListener("click", async () => {
      if (!tempSelected) return showMsg("Selecione uma data.", true);
      const ymd = toYMD(tempSelected);
      elDataReal.value = ymd;
      elDataVisual.value = ymdToHuman(ymd);
      closeCal();
      await carregarHorarios();
    });

    elDataVisual.addEventListener("click", () => {
      if (elDataVisual.disabled) return;
      openCal();
    });

    async function carregarHorarios(){
      clearMsg();
      elHorarios.innerHTML = "";
      elHorarioReal.value = "";
      elBtnConfirmar.disabled = true;

      const barberId = elBarberId.value;
      const data = elDataReal.value;

      if (!barberId) return resetDataEHorarios("Escolha um barbeiro para liberar a data.");
      if (!data) return resetDataEHorarios("Escolha uma data para carregar os hor√°rios.");

      elSubinfo.textContent = `Buscando hor√°rios para ${ymdToHuman(data)}...`;

      try{
        const res = await fetch(`/horarios?data=${encodeURIComponent(data)}&barberId=${encodeURIComponent(barberId)}`);
        if(!res.ok) throw new Error("Falha ao buscar hor√°rios.");
        const horarios = await res.json();

        if(!Array.isArray(horarios) || horarios.length === 0){
          elSubinfo.textContent = "Nenhum hor√°rio dispon√≠vel nessa data para esse barbeiro.";
          return;
        }

        elSubinfo.textContent = "Selecione um hor√°rio:";
        horarios.forEach(h => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "hora";
          btn.textContent = h;

          btn.addEventListener("click", () => {
            document.querySelectorAll(".hora").forEach(x => x.classList.remove("selected"));
            btn.classList.add("selected");
            elHorarioReal.value = h;
            elBtnConfirmar.disabled = false;
          });

          elHorarios.appendChild(btn);
        });

      }catch(e){
        elSubinfo.textContent = "Erro ao buscar hor√°rios.";
        showMsg("Erro: " + (e?.message || "Erro desconhecido"), true);
      }
    }

    // ‚úÖ SUBMIT CORRIGIDO: envia x-www-form-urlencoded (n√£o multipart)
    document.getElementById("formAgendar").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg();

      if (!elBarberId.value) return showMsg("Selecione um barbeiro.", true);
      if (!elDataReal.value) return showMsg("Selecione uma data.", true);
      if (!elHorarioReal.value) return showMsg("Selecione um hor√°rio.", true);

      const form = e.target;
      const fd = new FormData(form);

      // transforma em URL encoded -> bodyParser l√™ certinho
      const body = new URLSearchParams();
      for (const [k, v] of fd.entries()) body.append(k, v);

      try{
        const res = await fetch("/agendar", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: body.toString()
        });

        const text = await res.text();

        // se vier HTML, renderiza a p√°gina de sucesso
        if (res.ok && (text.includes("<!DOCTYPE") || text.includes("<html"))) {
          document.open(); document.write(text); document.close();
          return;
        }

        if (!res.ok) throw new Error(text || "Erro ao agendar.");
        showMsg(text || "Agendamento realizado!");
      }catch(err){
        showMsg("Erro: " + (err?.message || "Erro ao agendar."), true);
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      elDataVisual.disabled = true;
      elDataVisual.placeholder = "Escolha o barbeiro primeiro";
      carregarBarbeiros();
    });
  </script>
</body>
</html>
